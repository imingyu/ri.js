{"version":3,"file":"ri.common.js","sources":["../src/index.js"],"sourcesContent":["import { version } from '../package.json';\r\n\r\nexport var VERSION = version;\r\n\r\n/**\r\n * 定义一个拦截器集合\r\n * @param {string} id \r\n */\r\nexport function RequestInterceptorSet(id) {\r\n    this.id = id;\r\n    var $set = [];\r\n\r\n    this.has = function (name) {\r\n        return $set.some((item) => {\r\n            return item.name === name;\r\n        });\r\n    }\r\n\r\n    this.get = function (name) {\r\n        return $set.find((item) => {\r\n            return item.name === name;\r\n        })\r\n    }\r\n\r\n    this.append = function (name, handler) {\r\n        var item = this.get(name);\r\n        if (item) {\r\n            item.handler = handler;\r\n        } else {\r\n            $set.push({\r\n                name: name,\r\n                handler: handler,\r\n                enabled: true\r\n            });\r\n        }\r\n        return this;\r\n    }\r\n\r\n    this.remove = function (name) {\r\n        var item = this.get(name);\r\n        if (item) {\r\n            $set.splice($set.indexOf(item), 1);\r\n        }\r\n        return item;\r\n    }\r\n\r\n    this.disable = function (name) {\r\n        var item = this.get(name);\r\n        if (item) {\r\n            item.enabled = false;\r\n        }\r\n        return this;\r\n    }\r\n\r\n    this.enable = function (name) {\r\n        var item = this.get(name);\r\n        if (item) {\r\n            item.enabled = true;\r\n        }\r\n        return this;\r\n    }\r\n\r\n    this.insertBefore = function (beforeName, name, handler) {\r\n        var beforeItem = this.get(beforeName),\r\n            item = this.get(name);\r\n        if (!beforeItem) {\r\n            this.append(name, handler);\r\n            return this;\r\n        }\r\n        var i = $set.indexOf(beforeItem);\r\n        if (item) {\r\n            var itemIndex = $set.indexOf(item);\r\n            item.handler = handler ? handler : item.handler;\r\n            $set.splice(i, 0, item);\r\n            $set.splice(itemIndex, 1);\r\n        } else {\r\n            item = {\r\n                name: name,\r\n                handler: handler,\r\n                enabled: true\r\n            };\r\n            $set.splice(i, 0, item);\r\n        }\r\n        return this;\r\n    }\r\n\r\n    this.parallel = function () {\r\n        var args = Array.from(arguments),\r\n            ignoreInterceptors = args[0];\r\n        args.splice(0, 1);//排除第一个参数\r\n        return Promise.all($set.filter((item) => {\r\n            return item.enabled && ignoreInterceptors.indexOf(item.name) === -1;\r\n        }).map((item) => {\r\n            return item.handler.apply(item.context || null, args);\r\n        }));\r\n    }\r\n\r\n    this.serial = function () {\r\n        var args = Array.from(arguments),\r\n            ignoreInterceptors = args[0];\r\n        args.splice(0, 1);//排除第一个参数\r\n\r\n        var items = $set.filter((item) => {\r\n            return item.enabled && ignoreInterceptors.indexOf(item.name) === -1;\r\n        }).map((item) => {\r\n            return item.handler;\r\n        });\r\n\r\n        var handler = items.shift(),\r\n            result = handler.apply(null, args);\r\n        while (handler = items.shift()) {\r\n            result = result.then(handler);\r\n        }\r\n        return result;\r\n    }\r\n}\r\n\r\n/**\r\n * Request工厂\r\n * @param {RequestInterceptorSet} interceptor \r\n */\r\nexport function RequestFactory(interceptor) {\r\n    this.$interceptor = interceptor;\r\n    /**\r\n     * 创建一个Request\r\n     * requestHandler：真实的API处理函数\r\n     * ignoreInterceptors：需要排除的过滤器列表，传入字符串数组\r\n     */\r\n    this.createRequest = function (requestHandler, ignoreInterceptors) {\r\n        ignoreInterceptors = ignoreInterceptors || [];/*before：代表整个before过滤器都不走，after同理 */\r\n        var fac = this,\r\n            itr = fac.$interceptor,\r\n            before = itr.before && itr.before.parallel && ignoreInterceptors.indexOf('before') == -1 ? itr.before : {\r\n                parallel: function () {\r\n                    return Promise.resolve();\r\n                }\r\n            },\r\n            after = itr.after && itr.after.serial && ignoreInterceptors.indexOf('after') == -1 ? itr.after : {\r\n                serial: function (ignoreInterceptors, apiPromise) {\r\n                    return apiPromise;\r\n                }\r\n            };\r\n        return function () {\r\n            var args = Array.from(arguments);\r\n            return before.parallel.apply(before, [ignoreInterceptors].concat(args)).then(() => {\r\n                return after.serial.call(after, ignoreInterceptors, requestHandler.apply(null, args));\r\n            });\r\n        }\r\n    }\r\n}"],"names":["VERSION","version","RequestInterceptorSet","id","$set","has","name","some","item","get","find","append","handler","push","remove","splice","indexOf","disable","enabled","enable","insertBefore","beforeName","beforeItem","i","itemIndex","parallel","args","Array","from","arguments","ignoreInterceptors","Promise","all","filter","map","apply","context","serial","items","shift","result","then","RequestFactory","interceptor","$interceptor","createRequest","requestHandler","fac","itr","before","resolve","after","apiPromise","concat","call"],"mappings":"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"}